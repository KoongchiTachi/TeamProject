<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mappers.bid-mapper">

	<!-- 응찰 신청 -->
	<insert id="insertBid">  
		insert into tbl_bid(bno, m_id, b_price, b_date, b_note, pno)
		values (seq_bno.nextval, #{m_id}, #{b_price}, sysdate, #{b_note}, #{pno})
	</insert>
	
	<!-- 낙찰 예정자 확인 -->
	<select id="checkExpectedSuccess" resultType="int">
		select count(*) from tbl_bid
		where b_note = '낙찰예정' and pno = #{pno}
	</select>
	
	<!-- 낙찰 예정자 변경 -->
	<update id="changeExpectedSuccess">
		update tbl_bid
		set b_note = ''
		where b_note = '낙찰예정' and pno = #{pno}
	</update>
	 
	<select id="bidList" resultType="BidVo">
		select * 
		from (select rownum rnum, a.*
			  from (select m.m_id, p.pno, b.bno, p.p_img1, p.p_info, p.p_price, b.b_price, b.b_date, s.s_name, p.p_name
					from tbl_bid b, tbl_product p, tbl_member m, code_state s
					where b.pno = p.pno and p.p_state = s.s_code and m.m_id = b.m_id and m.m_id = #{m_id} order by b.b_date desc) a)
		where rnum between #{startRow} and #{endRow}
	</select>
	
	<select id="getCount" resultType="int">
		select count(*) from tbl_bid 
		where m_id = #{m_id}
	</select>
	
	<select id="successBidList" resultType="BidVo">
		<!-- select * 
		from (select rownum rnum, a.*
			  from (select m.m_id, p.pno, b.bno, p.p_img1, p.p_info, b.b_price, b.b_date, p.p_name
					from tbl_bid b, tbl_product p, tbl_member m
					where p.pno = b.pno and b.m_id = m.m_id and m.m_id = #{m_id} and p.p_progress = 'p06') a)
		where rnum between #{startRow} and #{endRow} -->
		<!-- select * from 
			(select rownum rnum, a.* from 
				(select b.m_id, p.p_img1, p.p_name, p.p_info, b.b_price, b.b_date from tbl_bid b, tbl_product p
				where p.t_bidding = b.m_id and p.t_bidding = #{m_id} and rownum &lt;=1 order by b.bno desc) a)
		where rnum between #{startRow} and #{endRow}   -->
		select * from
			(select rownum rnum, a.* from
				(select b.m_id, p.p_img1, p.p_name, p.p_info, b.b_price, b.b_date from tbl_product p, tbl_bid b
					where p.t_bidding = #{m_id} and b.m_id = p.t_bidding and b.pno = p.pno and b.b_note = '낙찰예정') a)
		where rnum between #{startRow} and #{endRow}  
	</select> 
	
	<select id="successBidCount" resultType="int">
		select count(*) 
		from tbl_bid b, tbl_product p
		where p.pno = b.pno and p.p_progress = 'p06' and b.m_id = #{m_id}
	</select>

</mapper>